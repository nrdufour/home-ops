---

- hosts: all
  become: yes

  roles:
    - role: mikolak-net.raspi_config
      raspi_config_hostname: "{{ ansible_host }}"
    - geerlingguy.swap

  tasks:
    - name: Disabling HDMI Port
      lineinfile:
        path: /etc/rc.local
        regexp: '^/usr/bin/tvservice'
        line: '/usr/bin/tvservice -o'
        insertafter: '^exit'
        state: present

    - name: Enable cgroup via boot commandline if not already enabled
      lineinfile:
        path: /boot/cmdline.txt
        backrefs: yes
        regexp: '^((?!.*\bcgroup_enable=cpuset cgroup_memory=1 cgroup_enable=memory\b).*)$'
        line: '\1 cgroup_enable=cpuset cgroup_memory=1 cgroup_enable=memory'
      notify: reboot

    - name: Disable wifi and bluetooth
      blockinfile:
        path: /boot/config.txt
        block: |
          dtoverlay=disable-bt
          dtoverlay=disable-wifi
      notify: reboot

    # Disable wifi and bt modules
    - name: Block kernel modules from loading
      blockinfile:
        path: /etc/modprobe.d/raspi-blacklist.conf
        create: true
        block: |
          blacklist brcmfmac
          blacklist brcmutil
          blacklist hci_uart
          blacklist btbcm
          blacklist btintel
          blacklist rfcom
          blacklist btqca
          blacklist btsdio
          blacklist bluetooth
      notify: reboot

    - name: Disable hciuart
      systemd:
        name: hciuart
        state: stopped
        enabled: no
