---

- name: Add jetstack chart repo
  kubernetes.core.helm_repository:
    name: jetstack
    repo_url: "https://charts.jetstack.io"

- name: Ensure namespace cert-manager exists
  kubernetes.core.k8s:
    kubeconfig: /etc/rancher/k3s/k3s.yaml
    state: present
    definition:
      apiVersion: v1
      kind: Namespace
      metadata:
        name: cert-manager

- name: Deploy latest version of cert-manager chart inside cert-manager namespace with values
  kubernetes.core.helm:
    kubeconfig: /etc/rancher/k3s/k3s.yaml
    name: cert-manager
    chart_ref: jetstack/cert-manager
    release_namespace: cert-manager
    values:
      installCRDs: true

- name: Deploy private CA secret and register it as ClusterIssuer
  kubernetes.core.k8s:
    kubeconfig: /etc/rancher/k3s/k3s.yaml
    namespace: cert-manager
    template: "{{ item }}"
  loop:
    - cert-manager/ca-kp-secret.yml.j2
    - cert-manager/cluster-issuer.yml.j2
