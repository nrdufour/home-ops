---
- name: Deploy the private CA to each fedora node of the cluster
  hosts: fedora

  tasks:
    - name: Create the CA file in /etc/pki/ca-trust/source/anchors
      become: true
      ansible.builtin.copy:
        dest: "/etc/pki/ca-trust/source/anchors/private_ca_ptinem.crt"
        content: |
          {{ SECRET_CA_CRT }}
        owner: root
        group: root
        mode: '0644'
      notify:
        - Update CA certs
        - Restart k3s

  handlers:
    - name: Update CA certs
      become: true
      ansible.builtin.command: /usr/bin/update-ca-trust

    - name: Restart k3s
      become: true
      ansible.builtin.systemd:
        name: k3s
        state: restarted
