# Media Stack Setup Guide

This guide walks you through the prerequisites for deploying the *arr stack with VPN protection.

## Volume Architecture

The media stack uses a hybrid storage approach:

### Download Workflow
1. **NZBGet downloads** → Longhorn volume (`nzbget-downloads`, 200Gi, ReadWriteMany)
2. **Radarr/Sonarr import** → Read from shared Longhorn volume, move to NFS final destination
3. **Final storage** → NFS (`/tank/Media/Movies` or `/tank/Media/Series`)

### Volume Mounts

**nzbget:**
- `/config` → `nzbget-config` PVC (Longhorn, 1Gi)
- `/data/Downloads` → `nzbget-downloads` PVC (Longhorn, 200Gi, shared)

**radarr:**
- `/config` → `radarr-config` PVC (Longhorn, 5Gi)
- `/data/Downloads` → `nzbget-downloads` PVC (Longhorn, 200Gi, shared)
- `/data/media/Movies` → NFS (cardinal.internal:/tank/Media/Movies)
- `/data/torrents` → NFS (cardinal.internal:/tank/Media/torrents)

**sonarr:**
- `/config` → `sonarr-config` PVC (Longhorn, 5Gi)
- `/data/Downloads` → `nzbget-downloads` PVC (Longhorn, 200Gi, shared)
- `/data/media/Series` → NFS (cardinal.internal:/tank/Media/Series)
- `/data/torrents` → NFS (cardinal.internal:/tank/Media/torrents)

### Why This Architecture?

- **Fast downloads:** Longhorn provides fast local storage for active downloads
- **Shared access:** ReadWriteMany allows nzbget, radarr, and sonarr to access the same volume
- **Efficient moves:** Radarr/Sonarr can efficiently move files from Longhorn to NFS
- **NFS for final storage:** Large media library remains on NFS for capacity and accessibility

## Prerequisites

### 1. NFS Storage Setup

Create the required directory structure on `cardinal.internal`:

```bash
# SSH to cardinal.internal
ssh cardinal.internal

# Create torrents directory structure (for qBittorrent)
sudo mkdir -p /tank/Media/torrents

# Ensure media directories exist
sudo mkdir -p /tank/Media/Movies
sudo mkdir -p /tank/Media/Series

# Set appropriate permissions (adjust user/group as needed)
sudo chown -R 1000:1000 /tank/Media/torrents
sudo chown -R 1000:1000 /tank/Media/Movies
sudo chown -R 1000:1000 /tank/Media/Series
sudo chmod -R 775 /tank/Media/{torrents,Movies,Series}
```

**Verify NFS export:**
```bash
# From your local machine or cluster node
showmount -e cardinal.internal

# Should show:
# /tank/Media    10.0.0.0/8
```

**Note:** Downloads are handled via a shared Longhorn volume (`nzbget-downloads`, 200Gi) mounted by nzbget, radarr, and sonarr. NFS is only used for the final media destinations and torrent downloads.

### 2. ProtonVPN Wireguard Configuration

#### Step 1: Download Wireguard Config

1. Login to ProtonVPN: https://account.protonvpn.com/
2. Navigate to **Downloads** section
3. Select **WireGuard configuration**
4. Choose any server (the private key is the same for all servers)
5. Download the `.conf` file

#### Step 2: Extract Private Key

Open the downloaded config file. It will look like this:

```ini
[Interface]
PrivateKey = YourBase64PrivateKeyHere==
Address = 10.2.0.2/32
DNS = 10.2.0.1

[Peer]
PublicKey = ServerPublicKeyHere==
AllowedIPs = 0.0.0.0/0
Endpoint = node-us-01.protonvpn.net:51820
```

**Copy the `PrivateKey` value** (the long base64 string after `PrivateKey = `)

**Note:** Keep this key secure! Anyone with this key can use your ProtonVPN connection.

### 3. Bitwarden Setup

#### Create "Media Stack" Item

1. Login to your Bitwarden vault
2. Create a new **Login** or **Secure Note** item
3. Name it: **Media Stack**

#### Add Custom Fields

Add the following custom fields:

**ProtonVPN Wireguard:**
- Field name: `PROTONVPN_WIREGUARD_PRIVATE_KEY`
- Type: Hidden (for security)
- Value: The private key you extracted from the Wireguard config

**qBittorrent Web UI:**
- Field name: `QBITTORRENT_USERNAME`
- Type: Text
- Value: `admin` (or your preferred username)

- Field name: `QBITTORRENT_PASSWORD`
- Type: Hidden
- Value: Generate a strong password (use Bitwarden's password generator)

**API Keys (add later after first deployment):**
- Field name: `PROWLARR_API_KEY`
- Type: Hidden
- Value: (will be generated by Prowlarr on first startup)

- Field name: `SONARR_API_KEY`
- Type: Hidden
- Value: (will be generated by Sonarr on first startup)

- Field name: `RADARR_API_KEY`
- Type: Hidden
- Value: (will be generated by Radarr on first startup)

#### Get Bitwarden Item UUID

After creating the item:

**Via Web Vault:**
1. Open the "Media Stack" item
2. Look at the URL in your browser
3. The UUID is the last part of the URL
4. Format: `a1b2c3d4-e5f6-g7h8-i9j0-k1l2m3n4o5p6`

**Via Bitwarden CLI:**
```bash
# List items and find the UUID
bw list items | jq '.[] | select(.name=="Media Stack") | .id'
```

**Copy this UUID** - you'll need it to update the ExternalSecret manifests.

### 4. Update ExternalSecret Manifests

After creating the Bitwarden item, update the following files with your item UUID:

**Files to update:**
- `base/apps/media/qbittorrent/vpn-secret.yaml`
- `base/apps/media/qbittorrent/app-secret.yaml`

Replace `REPLACE_WITH_YOUR_BITWARDEN_ITEM_UUID` with your actual UUID.

Example:
```yaml
remoteRef:
  key: a1b2c3d4-e5f6-g7h8-i9j0-k1l2m3n4o5p6  # Your actual UUID
  property: PROTONVPN_WIREGUARD_PRIVATE_KEY
```

## Verification Checklist

Before deploying, ensure:

- [ ] `/tank/Media/torrents` directory exists on cardinal.internal
- [ ] NFS export is accessible from cluster: `showmount -e cardinal.internal`
- [ ] Bitwarden "Media Stack" item created with all required fields
- [ ] Bitwarden item UUID obtained
- [ ] ExternalSecret manifests updated with correct UUID
- [ ] ProtonVPN account is active and in good standing

## Deployment Order

Once prerequisites are complete:

1. **qBittorrent** - Deploy first, test VPN connectivity
2. **Prowlarr** - Deploy second, configure indexers
3. **Sonarr** - Deploy third, link to Prowlarr and qBittorrent
4. **Radarr** - Deploy fourth, link to Prowlarr and qBittorrent

## Post-Deployment Configuration

### qBittorrent Initial Setup

1. Access: `https://qbittorrent.internal`
2. Login with credentials from Bitwarden
3. Verify VPN connection:
   - Tools → Execution Log
   - Look for Gluetun connection messages
4. Configure download paths:
   - Settings → Downloads
   - Default Save Path: `/data/torrents/complete`
   - Temp Path: `/data/torrents/incomplete`

### Prowlarr Initial Setup

1. Access: `https://prowlarr.internal`
2. Settings → General → Security
3. Copy the **API Key** and save it to Bitwarden
4. Add indexers:
   - Indexers → Add Indexer
   - Choose your preferred indexers (public or private)

### Sonarr Initial Setup

1. Access: `https://sonarr.internal`
2. Settings → General → Security
3. Copy the **API Key** and save it to Bitwarden
4. Add Prowlarr:
   - Settings → Indexers → Add → Prowlarr
   - Use Prowlarr API key from Bitwarden
5. Add qBittorrent:
   - Settings → Download Clients → Add → qBittorrent
   - Host: `qbittorrent.media.svc.cluster.local`
   - Port: `8080`
   - Username/Password from Bitwarden
6. Configure Root Folder:
   - Settings → Media Management → Root Folders
   - Add: `/data/media/Series`

### Radarr Initial Setup

1. Access: `https://radarr.internal`
2. Settings → General → Security
3. Copy the **API Key** and save it to Bitwarden
4. Add Prowlarr:
   - Settings → Indexers → Add → Prowlarr
   - Use Prowlarr API key from Bitwarden
5. Add qBittorrent:
   - Settings → Download Clients → Add → qBittorrent
   - Host: `qbittorrent.media.svc.cluster.local`
   - Port: `8080`
   - Username/Password from Bitwarden
6. Configure Root Folder:
   - Settings → Media Management → Root Folders
   - Add: `/data/media/Movies`

## Testing VPN Connection

### From qBittorrent Pod

```bash
# Get the pod name
kubectl get pods -n media

# Exec into the Gluetun container
kubectl exec -n media <qbittorrent-pod-name> -c gluetun -- sh

# Check VPN IP (should show ProtonVPN IP, not your real IP)
wget -qO- https://am.i.mullvad.net/json

# Should return something like:
# {"ip":"xxx.xxx.xxx.xxx","country":"Netherlands","mullvad_exit_ip":false}
```

### Port Forwarding Verification

```bash
# Check Gluetun logs for forwarded port
kubectl logs -n media <qbittorrent-pod-name> -c gluetun | grep -i "port"

# Look for lines like:
# [port forwarding] forwarded port is 12345
```

## Troubleshooting

### VPN Not Connecting

**Check Gluetun logs:**
```bash
kubectl logs -n media <qbittorrent-pod-name> -c gluetun
```

**Common issues:**
- Invalid Wireguard private key
- ProtonVPN account suspended
- Network connectivity issues

**Solution:**
- Verify key in Bitwarden is correct
- Re-download Wireguard config from ProtonVPN
- Check ProtonVPN account status

### ExternalSecret Not Syncing

**Check ExternalSecret status:**
```bash
kubectl get externalsecret -n media
kubectl describe externalsecret -n media <secret-name>
```

**Common issues:**
- Wrong Bitwarden item UUID
- Field name mismatch
- ClusterSecretStore not ready

**Solution:**
- Verify UUID in Bitwarden
- Check field names match exactly (case-sensitive)
- Verify bitwarden-fields ClusterSecretStore exists

### NFS Mount Failing

**Check pod events:**
```bash
kubectl describe pod -n media <pod-name>
```

**Common issues:**
- cardinal.internal not reachable
- NFS export not configured
- Permission denied

**Solution:**
- Test: `ping cardinal.internal`
- Test: `showmount -e cardinal.internal`
- Check NFS export permissions on cardinal

### Can't Access Web UI

**Check ingress:**
```bash
kubectl get ingress -n media
kubectl describe ingress -n media <ingress-name>
```

**Common issues:**
- Certificate not issued
- DNS not resolving
- Source IP not whitelisted

**Solution:**
- Check certificate: `kubectl get certificate -n media`
- Verify DNS for `*.internal`
- Check you're on `10.0.0.0/8` network

## Security Notes

1. **Keep Wireguard key secure** - It's equivalent to your VPN credentials
2. **Use strong passwords** for all web UIs
3. **Rotate API keys** if they're ever exposed
4. **Don't commit secrets** to Git (ExternalSecrets handle this)
5. **Review qBittorrent logs** regularly for suspicious activity

## Next Steps

After successful deployment and testing:

1. Configure quality profiles in Sonarr/Radarr
2. Add your media library to track existing content
3. Set up Bazarr for subtitles (optional)
4. Configure Lidarr for music (optional)
5. Set up Readarr for books (optional)

## Resources

- [Gluetun Wiki](https://github.com/qdm12/gluetun-wiki/wiki)
- [ProtonVPN Support](https://protonvpn.com/support)
- [Prowlarr Wiki](https://wiki.servarr.com/prowlarr)
- [Sonarr Wiki](https://wiki.servarr.com/sonarr)
- [Radarr Wiki](https://wiki.servarr.com/radarr)
- [qBittorrent Documentation](https://github.com/qbittorrent/qBittorrent/wiki)

---
**Last Updated:** 2025-10-13
**For issues or questions:** See main documentation at `docs/arr-stack-implementation.md`
