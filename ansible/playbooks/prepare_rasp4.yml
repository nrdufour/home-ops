---
- name: Prepare Raspberry pi 4
  hosts: rasp4
  become: true

  tasks:

    - name: Ensure extra storage is properly formatted
      community.general.filesystem:
        dev: "{{ extra_storage_disk }}"
        fstype: "ext4"

    - name: Ensure the mount point exists before end
      ansible.builtin.file:
        path: /srv/extra
        state: directory
        owner: root
        group: root
        mode: '0755'

    - name: Mount the extra storage disk
      ansible.posix.mount:
        path: /srv/extra
        src: "{{ extra_storage_disk }}"
        fstype: "ext4"
        state: mounted

    - name: Prepare futur mount points for rancher in extra
      ansible.builtin.file:
        path: "/srv/extra/rancher"
        state: directory
        owner: root
        group: root
        mode: '0755'

    - name: Create a link for /var/lib/rancher pointing to the extra device
      ansible.builtin.file:
        src: "/srv/extra/rancher"
        dest: "/var/lib/rancher"
        state: link
        owner: root
        group: root
