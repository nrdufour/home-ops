---

- name: Ensure the hostname is properly set
  become: true
  ansible.builtin.hostname:
    name: "{{ ansible_host }}"
    use: "debian"
  notify:
    - stop k3s
    - reboot

- name: Disabling HDMI Port
  lineinfile:
    path: /etc/rc.local
    regexp: '^/usr/bin/tvservice'
    line: '/usr/bin/tvservice -o'
    insertafter: '^exit'
    state: present

- name: Enable cgroup via boot commandline if not already enabled
  lineinfile:
    path: /boot/cmdline.txt
    backrefs: yes
    regexp: '^((?!.*\bcgroup_enable=cpuset cgroup_memory=1 cgroup_enable=memory\b).*)$'
    line: '\1 cgroup_enable=cpuset cgroup_memory=1 cgroup_enable=memory'
  notify:
    - stop k3s
    - reboot

- name: Disable wifi and bluetooth
  blockinfile:
    path: /boot/config.txt
    block: |
      dtoverlay=disable-bt
      dtoverlay=disable-wifi
  notify:
    - stop k3s
    - reboot

# Disable wifi and bt modules
- name: Block kernel modules from loading
  blockinfile:
    path: /etc/modprobe.d/raspi-blacklist.conf
    create: true
    block: |
      blacklist brcmfmac
      blacklist brcmutil
      blacklist hci_uart
      blacklist btbcm
      blacklist btintel
      blacklist rfcom
      blacklist btqca
      blacklist btsdio
      blacklist bluetooth
  notify:
    - stop k3s
    - reboot

- name: Disable hciuart
  systemd:
    name: hciuart
    state: stopped
    enabled: no
